# KRNL Counter Test Project

A simple smart contract project to test the full KRNL CLI workflow on Sepolia testnet. This project demonstrates:
- Smart contract development with Solidity
- Deployment with Foundry scripts
- Automatic contract verification
- Automated interaction testing

## Features

- **Counter.sol**: Simple counter contract with increment, decrement, and reset functions
- **Deploy.s.sol**: Foundry deployment script
- **krnl-setup.sh**: Automated setup and deployment script
- **counter-interact.js**: Node.js script to interact with deployed contract (50 increments with statistics)

## Prerequisites

1. **Node.js & npm** (v18 or higher)
   ```bash
   node --version
   npm --version
   ```

2. **KRNL CLI** (will be installed automatically by setup script)
   ```bash
   npm install -g @krnl-dev/krnl-cli
   ```

3. **Sepolia ETH** (~0.01 ETH for deployment and testing)
   - Get from [Sepolia Faucet](https://sepoliafaucet.com/)
   - Or [Alchemy Sepolia Faucet](https://www.alchemy.com/faucets/ethereum-sepolia)

4. **Etherscan API Key** (for verification)
   - Get from [Etherscan](https://etherscan.io/myapikey)

## Setup

1. **Install dependencies**:
   ```bash
   npm install ethers dotenv
   ```

2. **Create `.env` file**:
   ```bash
   cp .env.example .env
   ```

3. **Configure `.env`**:
   ```env
   PRIVATE_KEY=your_private_key_here
   SEPOLIA_RPC_URL=https://rpc.sepolia.org
   ETHERSCAN_API_KEY=your_etherscan_api_key
   COUNTER_ADDRESS=  # Leave empty until deployed
   ```

## Deployment

Run the automated setup and deployment:

```bash
./krnl-setup.sh
```

This script will:
1. ✅ Check KRNL CLI installation
2. 🔧 Initialize the project (if needed)
3. 🔨 Compile the Counter contract
4. 🚀 Deploy to Sepolia testnet
5. 🔍 Verify contract on Etherscan

After deployment, **copy the contract address** from the output and add it to `.env`:
```env
COUNTER_ADDRESS=0x1234567890abcdef1234567890abcdef12345678
```

## Testing

Run the interaction script to test the deployed contract:

```bash
node counter-interact.js
```

This will:
- ✅ Check wallet balance
- 📊 Display initial counter value
- 🚀 Increment counter 50 times (with random 1-3s delays)
- ⛽ Track gas usage and costs
- 📈 Display final statistics

### Expected Output

```
🎯 Counter Interaction Test
============================
Contract Address: 0x1234...5678
Wallet Address: 0xabcd...ef01
Target Increments: 50
Delay Range: 1s - 3s

💰 Wallet Balance: 0.045000 ETH
📊 Initial Counter Value: 0

🚀 Starting increment operations...

[1/50] Incrementing... (current: 0)
  ⏳ Transaction sent: 0x9876...4321
  ✅ Success! New count: 1
  ⛽ Gas used: 43210 | Cost: 0.000432 ETH
  ⏰ Waiting 2.3s...

[2/50] Incrementing... (current: 1)
  ...

📈 Final Statistics
===================
Initial Count: 0
Final Count: 50
Actual Increments: 50

Success: 50
Failed: 0
Success Rate: 100.00%

Total Gas Used: 2160500
Total Gas Cost: 0.021605 ETH
Avg Gas Per Tx: 43210
Avg Cost Per Tx: 0.000432 ETH

Initial Balance: 0.045000 ETH
Final Balance: 0.023395 ETH
Total Spent: 0.021605 ETH

✅ Test completed!
```

## Manual Commands

If you prefer to run commands manually:

```bash
# Initialize project
krnl init

# Compile contracts
krnl compile

# Deploy to Sepolia
krnl deploy script/Deploy.s.sol:Deploy --network sepolia --verify --broadcast

# Interact with contract
node counter-interact.js
```

## Project Structure

```
krnl-counter-test/
├── Counter.sol              # Smart contract
├── script/
│   └── Deploy.s.sol         # Deployment script
├── krnl-setup.sh            # Setup automation
├── counter-interact.js      # Interaction script
├── .env                     # Environment variables (gitignored)
├── .env.example             # Environment template
├── README.md                # This file
└── foundry.toml             # Generated by KRNL init
```

## Contract Functions

### Counter.sol

- `increment()`: Increment counter by 1
- `decrement()`: Decrement counter by 1 (requires count > 0)
- `reset()`: Reset counter to 0 (owner only)
- `getCount()`: Get current counter value

### Events

- `Incremented(uint256 newCount, address indexed caller)`
- `Decremented(uint256 newCount, address indexed caller)`
- `Reset(address indexed caller)`

## Troubleshooting

### "KRNL CLI not found"
```bash
npm install -g @krnl-dev/krnl-cli
```

### "Insufficient balance"
Get Sepolia ETH from faucets:
- https://sepoliafaucet.com/
- https://www.alchemy.com/faucets/ethereum-sepolia

### "Verification failed"
Make sure `ETHERSCAN_API_KEY` is set in `.env` and valid.

### "Transaction reverted"
Check that:
1. You have enough Sepolia ETH
2. Counter address is correct in `.env`
3. Network is not congested (try increasing gas price)

## Gas Optimization Tips

Current gas usage per increment: ~43,000 gas

Possible optimizations:
1. Use `unchecked` for counter increment (saves ~100 gas)
2. Remove events (saves ~3,000 gas per tx)
3. Use `uint8` instead of `uint256` (minimal savings)

## Next Steps

After completing this test, you can:
1. Modify `Counter.sol` to add more features
2. Create additional contracts and test inter-contract calls
3. Add more complex deployment scripts
4. Test on other networks (mainnet, Arbitrum, etc.)

## Resources

- [KRNL CLI Documentation](https://www.npmjs.com/package/@krnl-dev/krnl-cli)
- [Foundry Book](https://book.getfoundry.sh/)
- [Ethers.js Documentation](https://docs.ethers.org/v6/)
- [Sepolia Testnet Info](https://sepolia.etherscan.io/)

## License

MIT
